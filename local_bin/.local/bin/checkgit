#!/bin/bash

source ~/.cache/wal/colors.sh

shell="bash"
bar="lemonbar -F ${background} -B ${color1} -g 1366x20 -p"
trm="urxvt -e ${shell}"
let exit_code=0

pkill lemonbar
for gr in $(fd --type d --hidden --maxdepth 5 --exclude .vim --exclude .cache --exclude .cargo --exclude .fzf '.git$' ~ ); do
	wd=$(dirname $gr)
	pushd $wd &> /dev/null
	status=$(git status)
	if [[ $status =~ "ntracked files" ]]; then
		echo "%{A:urxvt:}$wd   has untracked files" | ${bar} &
        let exit_code=1
	elif [[ $status =~ "branch is ahead" ]]; then
		echo "%{A:urxvt:}$wd   has current branch not pushed" | ${bar} &
        let exit_code=1
	elif [[ $status =~ "nothing to commit" ]]; then
		true
	else
		(echo "%{A:urxvt:}$wd   needs attention%{A}" | ${bar}) | bash &
        let exit_code=1
	fi
	popd &> /dev/null
done

exit $exit_code
