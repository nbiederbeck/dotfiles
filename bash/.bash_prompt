#!/bin/bash
. ~/.bash_colors

parse_git_branch() {
    git status --branch --short 2> /dev/null | head -1
}

parse_git_repo() {
    git remote -v 2> /dev/null | grep 'origin.*fetch' | \
    sed -E 's#^origin.*(git@|https?://)##;s/(.git)? .*$//;s/gitlab.com/lab/;s/github.com/hub/'
}

parse_git_status() {
    git status --short 2> /dev/null |\
        rg '^( M| A|\?\?)' --count
}

parse_git_away() {
    git status --short --branch 2> /dev/null | grep '^##' | grep '\[.&\]'
}

print_git() {
    gb=$(parse_git_branch)
    gs=$(parse_git_status)
    if [[ "${gb}" ]]; then 
        if [[ "${gs}" ]]; then
            printf "%s" "$(clr_brown clr_bold "$(parse_git_branch) $(parse_git_state) $(parse_git_away)")"
        else
            printf "%s" "$(clr_green "${gb}")"
        fi
    else
        echo ""
    fi
}

reset_prompt() {
    PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
    prompt="$(print_git)\n"
    PS1="${prompt}${PS1}"
}

PROMPT_DIRTRIM=0
PROMPT_COMMAND=reset_prompt
